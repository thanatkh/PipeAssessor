<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pipe Assessor – v15</title>
<style>
  :root{
    --bg:#f8fafc;--surface:#ffffff;--ink:#0f172a;--muted:#475569;--muter:#64748b;
    --ok:#059669;--warn:#f59e0b;--danger:#dc2626;
    --brand:#103C5C; --primary:#156B95;
    --loss:#ef4444; --req:#6366f1; --ca:#94a3b8;
    --row:#f1f5f9; --base:#e5e7eb;
    --sum:#eef1f5; --sumBorder:#cbd5e1;
  }
  *{box-sizing:border-box}
  html,body{background:#f8fafc;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
  .wrap{max-width:1100px;margin:auto;padding:20px}
  header{background:var(--brand);color:#fff;position:sticky;top:0;z-index:1}
  header .wrap{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;position:relative}
  h1{font-size:18px;margin:0}
  .hdr-logo{height:50px;width:auto;object-fit:contain}
  .grid{display:grid;gap:16px}
  .card{background:#fff;border-radius:12px;box-shadow:0 10px 25px -5px rgba(0,0,0,.08), 0 10px 10px -5px rgba(0,0,0,.04);padding:0}
  .card-inner{padding:18px}
  label{display:block;font-size:12px;color:#475569;margin-bottom:6px}
  label .title{font-weight:700;color:#0f172a}
  input,select{width:100%;padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;font-size:14px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:740px){.row{grid-template-columns:1fr}}
  .kv{display:flex;align-items:center;justify-content:space-between;border-bottom:1px dashed #e2e8f0;padding:8px 10px;border-radius:8px;transition:background .15s}
  .kv:hover{background:var(--row)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .hint{font-size:12px;color:#64748b;margin-top:6px}
  .status{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;color:#fff;font-weight:600;font-size:12px}
  .s-ok{background:var(--ok)} .s-mon{background:var(--warn)} .s-rep{background:var(--danger)}
  .callout{margin:10px 0;padding:10px 12px;border-radius:10px;font-size:13px}
  .c-warn{background:#fff7ed;border:1px solid #fed7aa;color:#7c2d12}
  .c-bad{background:#fee2e2;border:1px solid #fecaca;color:#7f1d1d}
  .btn{cursor:pointer;border-radius:10px;padding:10px 12px;font-size:14px}
  .btn-primary{background:#156B95;color:#fff;border:1px solid #0d4f6e}
  .btn-ghost{background:#fff;color:#0f172a;border:1px solid #cbd5e1}

  /* Segmented control */
  .segmented{display:inline-flex;border:1px solid #cbd5e1;border-radius:10px;overflow:hidden;background:#fff}
  .segmented button{padding:10px 14px;border:0;background:#fff;color:#334155;font-size:13px;cursor:pointer}
  .segmented button.active{background:#e2e8f0;font-weight:700}
  .segmented button + button{border-left:1px solid #cbd5e1}

  /* Accordion */
  details{border-radius:12px;overflow:hidden}
  summary{list-style:none;padding:14px 18px;cursor:pointer;display:flex;align-items:center;gap:10px;background:var(--sum); border-bottom:1px solid var(--sumBorder)}
  summary::-webkit-details-marker{display:none}
  .caret{width:12px;height:12px;border-right:2px solid #334155;border-bottom:2px solid #334155;transform:rotate(-45deg);transition:.15s}
  details[open] .caret{transform:rotate(45deg)}
  .title-txt{font-weight:800}

  /* Graphics */
  .graph-wrap{padding:8px 4px}
  .track-top{position:relative;height:54px;background:var(--base);overflow:hidden}
  .seg{position:absolute;left:0;top:0;height:100%}
  .seg-remaining{background:var(--brand)}
  .seg-loss{background:var(--loss)}
  .overlay{position:relative;margin-top:10px}
  .base{height:22px;background:var(--base);width:100%}
  .overlay .bar{position:absolute;left:0;top:0;height:22px}
  .overlay .req{background:var(--req)}
  .overlay .ca{background:var(--ca)}
  .val{position:absolute;top:6px;font-size:12px;font-weight:700;color:#fff;white-space:nowrap;transform:translateX(-50%)}
  .val.dark{color:#0f172a}
  .below{top:auto;bottom:2px;font-size:11px}
  .white{color:#fff}
  .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .chip{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;font-size:12px}
  .chip div{width:14px;height:8px}
  .box-remain{background:var(--brand)}
  .box-loss{background:var(--loss)}
  .box-req{background:var(--req)}
  .box-ca{background:var(--ca)}
  .box-nom{background:var(--base);border:1px dashed #cbd5e1}

  .footer{color:#94a3b8;font-size:12px;text-align:center;padding:16px 0;display:flex;gap:8px;flex-direction:column;align-items:center}
  .footer img{width:250px;height:auto;opacity:.95}

  .resgrid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
  @media (max-width:740px){.resgrid{grid-template-columns:1fr}}

  /* CSS equations */
  .eqs{margin-top:8px}
  .eq{font-size:14px;color:#0f172a;margin:10px 0}
  .frac{display:inline-block;vertical-align:middle}
  .frac .num{display:block;text-align:left;padding:0 6px}
  .frac .den{display:block;text-align:left;border-top:1px solid #0f172a;margin-top:2px;padding:1px 6px}
  .var{font-weight:700}
  .unit{color:#64748b;font-size:12px;margin-left:8px}

  @media print{
    *{-webkit-print-color-adjust:exact; print-color-adjust:exact}
    .btn{display:none!important}
    .card{box-shadow:none}
    body{background:#fff}
  }
</style>
</head>
<body>
<header>
  <div class="wrap" id="hdr">
    <div>
      <h1>Pipe Assessor (v15)</h1>
      <div class="subhead" id="hdrMeta">Tag: — • Location: — • P&ID: —</div>
    </div>
    <img class="hdr-logo" src="https://img2.pic.in.th/pic/RGB_OR_invert_logo-on-BlueOR-Trans.png" alt="OR Logo"/>
  </div>
</header>

<div class="wrap grid" style="margin-top:16px">

  <!-- Header meta -->
  <details open class="card">
    <summary><span class="caret"></span><span class="title-txt">Header Meta</span></summary>
    <div class="card-inner">
      <div class="row meta">
        <div>
          <label><span class="title">Tag</span></label>
          <input id="metaTag" placeholder='e.g., 14"-GAS-101-A'/>
        </div>
        <div>
          <label><span class="title">Location</span></label>
          <input id="metaLoc" placeholder="e.g., KBY Terminal – Berth 3"/>
        </div>
        <div>
          <label><span class="title">P&ID</span></label>
          <input id="metaPid" placeholder="e.g., KBY-PID-003 Rev.2"/>
        </div>
      </div>
    </div>
  </details>

  <!-- Inputs -->
  <details open class="card">
    <summary><span class="caret"></span><span class="title-txt">Inputs</span></summary>
    <div class="card-inner">

      <div class="segmented" id="modeSeg">
        <button data-mode="depth" class="active">Wall loss depth (depth)</button>
        <button data-mode="tmeas">Measured minimum (t<sub>meas</sub>)</button>
      </div>
      <div class="hint">
        Choose <b>Wall loss depth</b> to enter metal loss depth; the app computes <span class="mono">t_meas = t_nom − depth</span>.
        Or choose <b>Measured minimum</b> to input the minimum thickness directly.
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label><span class="title">Nominal Pipe Size (NPS)</span></label>
          <select id="nps"></select>
          <div class="hint">
            Per <b>ASME B36.10M</b>. OD (D) and nominal wall (t_nom) are taken from the table.
          </div>
        </div>
        <div>
          <label style="display:flex;justify-content:space-between;align-items:center">
            <span class="title">Schedule</span>
            <span style="display:flex;gap:8px;align-items:center;font-weight:700;color:#334155">
              <input id="ovrChk" type="checkbox" style="width:16px;height:16px;margin:0"> Override t<sub>nom</sub>
            </span>
          </label>
          <select id="sch"></select>
          <div class="hint">
            Policy: <b>½"–1½"</b> → <b>XS (Sch 80)</b>; <b>≥2"</b> → <b>STD (Sch 40)</b>. Use override if drawings/MTR differ.
          </div>
        </div>

        <div id="grpDepth">
          <label><span class="title">Wall loss depth (mm)</span></label>
          <input id="depth" type="number" step="0.01" placeholder="e.g., 1.2">
          <div class="hint">Max metal loss relative to original wall, from UT grid/pit gauge.</div>
        </div>
        <div id="grpTmeas" style="display:none">
          <label><span class="title">Measured minimum wall thickness (mm)</span></label>
          <input id="tmeas" type="number" step="0.01" value="6.0">
          <div class="hint">Minimum remaining thickness measured on pipe (after removing coating/scale when needed).</div>
        </div>

        <div>
          <label><span class="title">Corrosion allowance, CA (mm)</span></label>
          <input id="ca" type="number" step="0.1" value="1.5">
          <div class="hint">Design corrosion allowance per project/company standard.</div>
        </div>
        <div>
          <label><span class="title">Design pressure, P (bar)</span></label>
          <input id="Pbar" type="number" step="0.1" value="7.0">
          <div class="hint">Internal design pressure; converted to MPa for the equations.</div>
        </div>
        <div>
          <label><span class="title">Allowable stress, S (MPa)</span></label>
          <input id="S" type="number" step="1" value="138">
          <div class="hint">From company table or ASME B31.3 Table A-1 for the material and temperature.</div>
        </div>
        <div>
          <label><span class="title">Longitudinal joint factor, E</span></label>
          <input id="E" type="number" step="0.01" value="1.0">
          <div class="hint">Pipe seam quality factor per B31.3. Seamless/qualified ERW/SAW typically 1.0.</div>
        </div>
        <div>
          <label><span class="title">Weld strength reduction factor, W</span></label>
          <input id="W" type="number" step="0.01" value="1.0">
          <div class="hint">Usually 1.0 at ambient; apply table values in creep range.</div>
        </div>
        <div>
          <label><span class="title">B31.3 coefficient, Y</span></label>
          <input id="Y" type="number" step="0.05" value="0.4">
          <div class="hint">Geometry factor per B31.3 304 rules (common default 0.4).</div>
        </div>
        <div>
          <label><span class="title">Corrosion rate, CR (mm/year) — optional</span></label>
          <input id="CR" type="number" step="0.01" placeholder="e.g., 0.10">
          <div class="hint">Used to estimate Remaining Life until t_req + CA.</div>
        </div>
      </div>

      <!-- Override t_nom -->
      <div class="row" id="ovrRow" style="display:none">
        <div>
          <label><span class="title">Override nominal wall thickness (mm)</span></label>
          <input id="overrideTnom" type="number" step="0.01" placeholder="Use only when different from B36.10M table">
          <div class="hint">Enter if drawings/MTRs show a nominal wall different from schedule.</div>
        </div>
      </div>

      <!-- Audit trail -->
      <div class="row">
        <div>
          <label><span class="title">Entered by</span></label>
          <input id="enteredBy" placeholder="Assessor name">
        </div>
        <div>
          <label><span class="title">Remarks (optional)</span></label>
          <input id="remarks" placeholder="Notes">
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="recalc()">Calculate</button>
        <button class="btn btn-ghost" onclick="resetDefaults()">Reset</button>
        <button class="btn btn-ghost" onclick="savePDF()">Save as PDF</button>
      </div>

      <!-- Equations & References (CSS-based for compatibility) -->
      <div class="eqs">
        <div class="hint"><b>Equations (ASME B31.3):</b></div>
        <div class="eq">
          <span class="var">t</span> = 
          <span class="frac"><span class="num">P · D</span><span class="den">2 · (S · E · W + P · Y)</span></span>
        </div>
        <div class="eq">
          <span class="var">t<sub>req+CA</sub></span> = <span class="var">t</span> + <span class="var">CA</span>
        </div>
        <div class="eq">
          <span class="var">P</span> =
          <span class="frac"><span class="num">2 · S · E · W · t</span><span class="den">D − 2 · Y · t</span></span>
          <span class="unit">(MPa; divide by 0.1 to convert to bar)</span>
        </div>
        <div class="hint" style="margin-top:6px">
          <b>Symbols:</b> P = pressure (MPa), D = outside diameter (mm), S = allowable stress, E = longitudinal joint factor, W = weld strength reduction factor, Y = B31.3 coefficient, t = wall thickness (mm), CA = corrosion allowance.
        </div>
        <div class="hint" style="margin-top:8px">
          <b>References:</b> ASME B31.3 (para. 304 rules), ASME B36.10M, ASME PCC-2, API 579-1 / ASME FFS-1.
        </div>
      </div>
    </div>
  </details>

  <!-- Pipe Information -->
  <details open class="card">
    <summary><span class="caret"></span><span class="title-txt">Pipe Information</span></summary>
    <div class="card-inner">
      <div class="row">
        <div>
          <div class="kv"><div>Tag</div><div class="mono" id="tagShow">-</div></div>
          <div class="kv"><div>Location</div><div class="mono" id="locShow">-</div></div>
          <div class="kv"><div>P&amp;ID</div><div class="mono" id="pidShow">-</div></div>
          <div class="kv"><div>Nominal Pipe Size (NPS)</div><div class="mono" id="npsShow">-</div></div>
          <div class="kv"><div>Schedule</div><div class="mono" id="schShow">-</div></div>
        </div>
        <div>
          <div class="kv"><div>Nominal wall thickness</div><div class="mono" id="tnomShow">-</div></div>
          <div class="kv"><div>Measured minimum wall thickness</div><div class="mono" id="tmeasShow">-</div></div>
          <div class="kv"><div>Wall loss depth</div><div class="mono" id="depthShow">-</div></div>
          <div class="kv"><div>Corrosion allowance, CA</div><div class="mono" id="caShow">-</div></div>
          <div class="kv"><div>Design pressure</div><div class="mono" id="pbarShow2">-</div></div>
          <div class="kv"><div>Allowable stress, S</div><div class="mono" id="sShow">-</div></div>
          <div class="kv"><div>Audit trail</div><div class="mono" id="auditShow">-</div></div>
        </div>
      </div>
    </div>
  </details>

  <!-- Results -->
  <details open class="card">
    <summary><span class="caret"></span><span class="title-txt">Results</span></summary>
    <div class="card-inner">
      <div id="statusBox" style="margin-bottom:10px"></div>
      <div id="warnBox"></div>

      <!-- Graphics -->
      <div class="graph-wrap">
        <!-- Top: Remaining + Loss (Nominal=100%) -->
        <div class="track-top" id="trackMain">
          <div class="seg seg-remaining" id="segRemain" style="width:0%"></div>
          <div class="seg seg-loss" id="segLoss" style="width:0%"></div>
          <div class="val" id="lblRemain" style="left:-9999px">Remaining</div>
          <div class="val" id="lblLoss" style="left:-9999px">Loss</div>
        </div>

        <!-- Bottom: base 100% + overlays (Req + CA) -->
        <div class="overlay" id="overlay">
          <div class="base"></div>
          <div class="bar req" id="segReq" style="width:0%"></div>
          <div class="bar ca"  id="segCA"  style="left:0;width:0%"></div>
          <div class="val white below" id="lblReq" style="left:-9999px">Req</div>
          <div class="val dark below"  id="lblCA"  style="left:-9999px">CA</div>
        </div>

        <div class="legend">
          <span class="chip"><div class="box-nom"></div> Nominal = 100%</span>
          <span class="chip"><div class="box-remain"></div> Remaining</span>
          <span class="chip"><div class="box-loss"></div> Wall loss</span>
          <span class="chip"><div class="box-req"></div> Required (no CA)</span>
          <span class="chip"><div class="box-ca"></div> CA</span>
        </div>
      </div>

      <!-- Values -->
      <div class="resgrid" style="margin-top:14px">
        <div class="kv"><div>Nominal wall thickness</div><div class="mono" id="tnom">-</div></div>
        <div class="kv"><div>Remaining vs nominal</div><div class="mono" id="pct">-</div></div>
        <div class="kv"><div>Required (without CA)</div><div class="mono" id="treq">-</div></div>
        <div class="kv"><div>Required (incl. CA)</div><div class="mono" id="treqca">-</div></div>
        <div class="kv"><div>Margin</div><div class="mono" id="margin">-</div></div>
        <div class="kv"><div>Design pressure</div><div class="mono" id="pbarShow">-</div></div>
        <div class="kv"><div>MAWP (t<sub>use</sub>=t<sub>meas</sub>−CA)</div><div class="mono" id="mawpWith">-</div></div>
        <div class="kv"><div>MAWP (no CA)</div><div class="mono" id="mawpNoCA">-</div></div>
        <div class="kv"><div>Corrosion rate, CR</div><div class="mono" id="crShow">-</div></div>
        <div class="kv"><div>Estimated remaining life</div><div class="mono" id="rlife">-</div></div>
      </div>

      <div id="notes" class="hint" style="margin-top:10px"></div>
      <div class="hint" style="margin-top:6px">
        <b>MAWP note:</b> formula yields MPa; divide by 0.1 to convert to bar.
      </div>
    </div>
  </details>

  <!-- Repair Advisor -->
  <details open class="card">
    <summary><span class="caret"></span><span class="title-txt">Repair Advisor (ASME PCC-2)</span></summary>
    <div class="card-inner">
      <div id="advisor" class="muted">Enter inputs and click Calculate.</div>
      <div id="advisorList" style="margin-top:8px"></div>
      <div class="hint" style="margin-top:10px">
        <b>PCC-2 categories:</b> Part 2 – Composite, Part 3 – Welded, Part 4 – Mechanical. Recommendations depend on STATUS.
      </div>
    </div>
  </details>

  <div class="footer">
    <img src="https://uppic.cloud/ib/TegMMWNNMoyhrHv_1736230877.png" alt="Division Logo"/>
    <div><strong>Central and Eastern Engineering and Maintenance Division</strong></div>
    <div>PTT Oil and Retail Business Public Company Limited</div>
  </div>
</div>

<script>
/* ===== Pipe data (B36.10M subset; XS for ½–1½", STD for ≥2") ===== */
const PIPE_DIMS = [
  { nps:'1/2"',   schedule:'80', od_mm:21.34,  t_nom_mm:3.73 },
  { nps:'3/4"',   schedule:'80', od_mm:26.67,  t_nom_mm:3.91 },
  { nps:'1"',     schedule:'80', od_mm:33.40,  t_nom_mm:4.55 },
  { nps:'1-1/4"', schedule:'80', od_mm:42.16,  t_nom_mm:4.85 },
  { nps:'1-1/2"', schedule:'80', od_mm:48.26,  t_nom_mm:5.08 },
  { nps:'2"',     schedule:'40', od_mm:60.33,  t_nom_mm:3.91 },
  { nps:'2-1/2"', schedule:'40', od_mm:73.03,  t_nom_mm:5.16 },
  { nps:'3"',     schedule:'40', od_mm:88.90,  t_nom_mm:5.49 },
  { nps:'3-1/2"', schedule:'40', od_mm:101.60, t_nom_mm:5.74 },
  { nps:'4"',     schedule:'40', od_mm:114.30, t_nom_mm:6.02 },
  { nps:'5"',     schedule:'40', od_mm:141.30, t_nom_mm:6.55 },
  { nps:'6"',     schedule:'40', od_mm:168.28, t_nom_mm:7.11 },
  { nps:'8"',     schedule:'40', od_mm:219.08, t_nom_mm:8.18 },
  { nps:'10"',    schedule:'40', od_mm:273.05, t_nom_mm:9.27 },
  { nps:'12"',    schedule:'40', od_mm:323.85, t_nom_mm:9.53 },
  { nps:'14"',    schedule:'40', od_mm:355.60, t_nom_mm:9.53 },
  { nps:'16"',    schedule:'40', od_mm:406.40, t_nom_mm:9.53 },
  { nps:'18"',    schedule:'40', od_mm:457.20, t_nom_mm:9.53 },
  { nps:'20"',    schedule:'40', od_mm:508.00, t_nom_mm:9.53 },
  { nps:'22"',    schedule:'40', od_mm:558.80, t_nom_mm:9.53 },
  { nps:'24"',    schedule:'40', od_mm:609.60, t_nom_mm:9.53 },
  { nps:'26"',    schedule:'40', od_mm:660.40, t_nom_mm:9.53 },
  { nps:'28"',    schedule:'40', od_mm:711.20, t_nom_mm:9.53 },
  { nps:'30"',    schedule:'40', od_mm:762.00, t_nom_mm:11.13 },
  { nps:'32"',    schedule:'40', od_mm:812.80, t_nom_mm:11.13 },
  { nps:'34"',    schedule:'40', od_mm:863.60, t_nom_mm:11.13 },
  { nps:'36"',    schedule:'40', od_mm:914.40, t_nom_mm:12.70 },
];
const NPS_ORDER = ['1/2"','3/4"','1"','1-1/4"','1-1/2"','2"','2-1/2"','3"','3-1/2"','4"','5"','6"','8"','10"','12"','14"','16"','18"','20"','22"','24"','26"','28"','30"','32"','34"','36"'];

const npsSel = document.getElementById('nps');
const schSel = document.getElementById('sch');
const modeSeg = document.getElementById('modeSeg');
const ovrChk = document.getElementById('ovrChk');
const hdrMeta = document.getElementById('hdrMeta');

function fillNps(){ npsSel.innerHTML = NPS_ORDER.map(v=>`<option>${v}</option>`).join(''); }
function fillSch(){
  const nps = npsSel.value;
  const small = ['1/2"','3/4"','1"','1-1/4"','1-1/2"'];
  let opts = [];
  if (small.includes(nps)){ opts = [{v:'80', label:'XS (Sch 80)'}]; }
  else { opts = [{v:'40', label:'STD (Sch 40)'}]; }
  schSel.innerHTML = opts.map(o=>`<option value="${o.v}">${o.label}</option>`).join('');
}

function onModeClick(e){
  if (e.target.tagName!=='BUTTON') return;
  [...modeSeg.children].forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  const mode = e.target.dataset.mode;
  document.getElementById('grpTmeas').style.display = (mode==='tmeas') ? '' : 'none';
  document.getElementById('grpDepth').style.display = (mode==='depth') ? '' : 'none';
  recalc();
}
modeSeg.addEventListener('click', onModeClick);

npsSel.addEventListener('change', ()=>{ fillSch(); recalc(); });
schSel.addEventListener('change', recalc);
ovrChk.addEventListener('change', ()=>{
  document.getElementById('ovrRow').style.display = ovrChk.checked ? '' : 'none';
  recalc();
});

/* Save PDF with tag in file name (via title) */
let _origTitle = document.title;
function savePDF(){
  const tag = (document.getElementById('metaTag').value || 'Pipe Assessor');
  const title = `Pipe Assessor - ${tag}`;
  _origTitle = document.title;
  document.title = title;
  window.print();
}
window.addEventListener('afterprint', ()=>{ document.title = _origTitle; });

function lookupDim(nps, sch){
  return PIPE_DIMS.find(d => d.nps===nps && d.schedule===sch) || null;
}

function calcB313({D, t_meas, c, Pbar, S, E, W, Y, t_nom}){
  const P = Pbar * 0.1; // bar -> MPa
  const denom = 2*(S*E*W + P*Y);
  const t_req_noCA = (P*D)/denom;
  const t_req_total = t_req_noCA + c;
  const margin = t_meas - t_req_total;
  const pctRemainNom = (t_meas / t_nom) * 100;

  function calcMAWP(t_use){
    const denomM = (D - 2*Y*t_use);
    if (t_use<=0 || denomM<=0) return null;
    const Pmpa = (2*S*E*W*t_use) / denomM; // MPa
    return Pmpa / 0.1; // bar
  }
  const mawp_with = calcMAWP(Math.max(0, t_meas - c));
  const mawp_no   = calcMAWP(t_meas);

  let status = 'OK';
  const notes = [];
  const warns = [];
  if (margin < 0){ status='REPAIR'; notes.push('Measured thickness is below required (incl. CA).'); }
  else if (margin < 0.1*t_req_total){ status='MONITOR'; warns.push('Thickness approaching limit: margin < 10% of requirement.'); }
  if (pctRemainNom < 50 && status==='OK'){ status='MONITOR'; warns.push('Remaining vs nominal < 50%.'); }

  return {t_req_noCA, t_req_total, margin, pctRemainNom, status, notes, warns, mawp_with, mawp_no};
}
function fmt(x, d=2){ return (isFinite(x) ? Number(x).toFixed(d) : '-'); }
function statusBadge(s){
  const cls = s==='OK' ? 's-ok' : s==='MONITOR' ? 's-mon' : 's-rep';
  return `<span class="status ${cls}"><span>STATUS</span> ${s}</span>`;
}

/* Bars (Nominal = 100%) */
function drawBars({t_nom, t_meas, t_req_noCA, c}){
  const scale = Math.max(t_nom, 1e-6);
  const wRemain = 100 * Math.max(0, Math.min(t_meas, t_nom)) / scale;
  const wLoss = 100 * Math.max(0, t_nom - Math.min(t_meas, t_nom)) / scale;

  const segRemain = document.getElementById('segRemain');
  const segLoss   = document.getElementById('segLoss');
  segRemain.style.width = wRemain + '%';
  segLoss.style.left = wRemain + '%';
  segLoss.style.width = wLoss + '%';

  placeLabel('lblRemain', wRemain, `Remaining ${fmt(t_meas,2)} mm`);
  placeLabel('lblLoss',   wLoss,   (wLoss>0 ? `Loss ${fmt(t_nom - t_meas,2)} mm` : ''), wRemain);

  const wReq = 100 * Math.max(0, t_req_noCA) / scale;
  const wCA  = 100 * Math.max(0, c) / scale;
  const reqWidth = Math.min(100, wReq);
  const caLeft = reqWidth;
  const caWidth = Math.min(100 - caLeft, wCA);
  document.getElementById('segReq').style.width = reqWidth + '%';
  document.getElementById('segCA').style.left = caLeft + '%';
  document.getElementById('segCA').style.width = caWidth + '%';
  placeLabel('lblReq', reqWidth, `Req ${fmt(t_req_noCA,2)} mm`, 0, true, false, true);
  placeLabel('lblCA',  caWidth,  `CA ${fmt(c,2)} mm`, caLeft, true, true, false);
}
function placeLabel(id, w, text, offset=0, below=false, useDark=false, forceWhite=false){
  const el = document.getElementById(id);
  if (!text || w < 8){ el.style.left = '-9999px'; return; }
  el.style.left = `calc(${offset + w/2}% )`;
  el.textContent = text;
  el.classList.toggle('below', !!below);
  el.classList.toggle('dark', !!useDark);
  el.classList.toggle('white', !!forceWhite);
}

/* Advisor — show methods only when REPAIR; MONITOR has tips; OK none */
function advisorRules({status, t_nom, t_meas}){
  const out = {headline:'', bullets:[]};
  const lossPct = (1 - (t_meas / t_nom)) * 100;

  if (status === 'OK'){
    out.headline = 'Meets requirements — no repair needed';
    out.bullets.push('Continue normal inspection intervals.');
    if (lossPct > 50) out.bullets.push('Consider increasing UT frequency due to high % loss vs nominal.');
    return out;
  }

  if (status === 'MONITOR'){
    out.headline = 'Low margin — increase monitoring';
    out.bullets.push('Increase UT frequency; trend corrosion rate; plan re-check before next shutdown.');
    return out;
  }

  // REPAIR
  out.headline = 'Below required thickness — repair required';
  if (lossPct > 80){
    out.bullets.push('Loss > 80% of nominal — plan replacement of the spool (preferred).');
  }
  out.bullets.push(
    'PCC-2 Part 2 (Composite): engineered wrap (local or full wrap).',
    'PCC-2 Part 3 (Welded): Type B sleeve or weld build-up (requires WPS/PQR, NDE).',
    'PCC-2 Part 4 (Mechanical): clamp/encapsulation where hot work is restricted.',
    'After repair: surface prep and coating/CP improvement to slow future corrosion.'
  );
  return out;
}

function recalc(){
  const nps = npsSel.value;
  const sch = schSel.value;
  const dim = lookupDim(nps, sch);
  if (!dim) return;

  const D = dim.od_mm;

  let t_nom = null;
  if (ovrChk.checked){
    const tOvr = parseFloat(document.getElementById('overrideTnom').value);
    t_nom = (isFinite(tOvr) && tOvr>0) ? tOvr : null;
  } else {
    t_nom = dim.t_nom_mm;
  }

  const mode = document.querySelector('#modeSeg .active').dataset.mode;
  const depth = parseFloat(document.getElementById('depth')?.value);
  let t_meas = parseFloat(document.getElementById('tmeas')?.value);
  if (mode==='depth'){
    const d = isNaN(depth) ? 0 : depth;
    t_meas = Math.max(0, (t_nom||0) - d);
  }

  const c = parseFloat(document.getElementById('ca').value);
  const Pbar = parseFloat(document.getElementById('Pbar').value);
  const S = parseFloat(document.getElementById('S').value);
  const E = parseFloat(document.getElementById('E').value);
  const W = parseFloat(document.getElementById('W').value);
  const Y = parseFloat(document.getElementById('Y').value);
  const CR = parseFloat(document.getElementById('CR').value);

  const tag = (document.getElementById('metaTag').value || '—');
  const loc = (document.getElementById('metaLoc').value || '—');
  const pid = (document.getElementById('metaPid').value || '—');
  hdrMeta.textContent = `Tag: ${tag} • Location: ${loc} • P&ID: ${pid}`;

  document.getElementById('tagShow').textContent = tag;
  document.getElementById('locShow').textContent = loc;
  document.getElementById('pidShow').textContent = pid;
  document.getElementById('npsShow').textContent = nps;
  document.getElementById('schShow').textContent = (sch==='80' && ['1/2"','3/4"','1"','1-1/4"','1-1/2"'].includes(nps)) ? 'XS (Sch 80)' : 'STD (Sch 40)';
  document.getElementById('tnomShow').textContent = (t_nom && isFinite(t_nom)) ? `${fmt(t_nom,2)} mm` : '—';
  document.getElementById('tmeasShow').textContent = isFinite(t_meas) ? `${fmt(t_meas,2)} mm` : '—';
  document.getElementById('depthShow').textContent = isNaN(depth) ? '-' : `${fmt(depth,2)} mm`;
  document.getElementById('caShow').textContent = `${fmt(c,2)} mm`;
  document.getElementById('pbarShow2').textContent = `${fmt(Pbar,1)} bar`;
  document.getElementById('sShow').textContent = `${fmt(S,0)} MPa`;

  const name = (document.getElementById('enteredBy').value || '—');
  const stamp = new Date().toLocaleString();
  document.getElementById('auditShow').textContent = `${name} @ ${stamp}`;

  if (!t_nom || !isFinite(t_nom) || t_nom<=0){
    document.getElementById('statusBox').innerHTML = '<span class="status s-mon">Please provide nominal thickness (override) to compute.</span>';
    clearVisuals();
    return;
  }

  let r;
  try{ r = calcB313({D, t_meas, c, Pbar, S, E, W, Y, t_nom}); }catch(e){ console.error(e); return; }

  document.getElementById('tnom').textContent   = `${fmt(t_nom,2)} mm`;
  document.getElementById('treq').textContent   = `${fmt(r.t_req_noCA,3)} mm`;
  document.getElementById('treqca').textContent = `${fmt(r.t_req_total,3)} mm`;
  document.getElementById('margin').textContent = `${fmt(r.margin,3)} mm`;
  document.getElementById('pct').textContent    = `${fmt(r.pctRemainNom,0)} %`;
  document.getElementById('mawpWith').textContent = (r.mawp_with!=null) ? `${fmt(r.mawp_with,2)} bar` : '—';
  document.getElementById('mawpNoCA').textContent = (r.mawp_no!=null) ? `${fmt(r.mawp_no,2)} bar` : '—';
  document.getElementById('pbarShow').textContent = `${fmt(Pbar,1)} bar`;
  document.getElementById('crShow').textContent   = isFinite(CR) ? `${fmt(CR,2)} mm/year` : '-';

  drawBars({t_nom, t_meas, t_req_noCA: r.t_req_noCA, c});

  document.getElementById('statusBox').innerHTML = statusBadge(r.status);
  const warnBox = document.getElementById('warnBox');
  warnBox.innerHTML = '';
  if (r.status === 'REPAIR'){
    warnBox.innerHTML = `<div class="callout c-bad"><b>Critical:</b> Measured thickness is below required (incl. CA). Reduce risk and plan repair.</div>`;
  } else if (r.warns.length){
    warnBox.innerHTML = `<div class="callout c-warn">${r.warns.map(x=>`<div>• ${x}</div>`).join('')}</div>`;
  }

  document.getElementById('notes').innerHTML = r.notes.length
    ? ('<ul>' + r.notes.map(x=>`<li>${x}</li>`).join('') + '</ul>') : '—';

  let RL = null;
  if (!isNaN(CR) && CR > 0){
    RL = (t_meas - r.t_req_total) / CR;
    document.getElementById('rlife').textContent = RL >= 0 ? `${fmt(RL,2)} years` : '0 (below requirement)';
  } else {
    document.getElementById('rlife').textContent = '-';
  }

  const adv = advisorRules({status:r.status, t_nom, t_meas});
  document.getElementById('advisor').textContent = adv.headline;
  document.getElementById('advisorList').innerHTML = adv.bullets.length
    ? '<ul>' + adv.bullets.map(x=>`<li>${x}</li>`).join('') + '</ul>' : '';
}

function clearVisuals(){
  ['segRemain','segLoss','segReq','segCA','lblRemain','lblLoss','lblReq','lblCA'].forEach(id=>{
    const el = document.getElementById(id);
    if (!el) return;
    if (el.classList.contains('seg') || el.classList.contains('bar')) el.style.width = '0%';
    else el.style.left = '-9999px';
  });
  ['treq','treqca','margin','pct','pbarShow','crShow','rlife','tnom','mawpWith','mawpNoCA'].forEach(id=>{
    const n=document.getElementById(id); if(n) n.textContent='-';
  });
}

/* Defaults */
function resetDefaults(){
  fillNps();
  npsSel.value = '4"';
  fillSch();
  schSel.value = '40';
  document.getElementById('Pbar').value = 7.0;
  document.getElementById('tmeas').value = 6.0;
  document.getElementById('depth').value = '';
  document.getElementById('ca').value = 1.5;
  document.getElementById('S').value = 138;
  document.getElementById('E').value = 1.0;
  document.getElementById('W').value = 1.0;
  document.getElementById('Y').value = 0.4;
  document.getElementById('CR').value = '';
  document.getElementById('overrideTnom').value = '';
  document.getElementById('ovrRow').style.display = 'none';
  ovrChk.checked = false;

  // Segmented default
  [...modeSeg.children].forEach(b=>b.classList.remove('active'));
  modeSeg.querySelector('button[data-mode="depth"]').classList.add('active');
  document.getElementById('grpDepth').style.display = '';
  document.getElementById('grpTmeas').style.display = 'none';

  hdrMeta.textContent = 'Tag: — • Location: — • P&ID: —';

  recalc();
}
['tmeas','depth','ca','Pbar','S','E','W','Y','CR','overrideTnom','enteredBy','remarks','metaTag','metaLoc','metaPid'].forEach(id=>{
  const el = document.getElementById(id);
  if (el) el.addEventListener('input', recalc);
});
resetDefaults();
</script>
</body>
</html>
